"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[288],{7826(e,r,t){t.r(r),t.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>n,toc:()=>u});const n=JSON.parse('{"id":"projects/security-ticket/troubleshooting/code_LoginService","title":"code_LoginService","description":"/service/common/LoginService","source":"@site/docs/projects/security-ticket/troubleshooting/code_LoginService.md","sourceDirName":"projects/security-ticket/troubleshooting","slug":"/projects/security-ticket/troubleshooting/code_LoginService","permalink":"/docs/projects/security-ticket/troubleshooting/code_LoginService","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"code_JPA-Specification","permalink":"/docs/projects/security-ticket/troubleshooting/code_JPA-Specification"},"next":{"title":"code_Native-Query","permalink":"/docs/projects/security-ticket/troubleshooting/code_Native-Query"}}');var o=t(4848),s=t(8453);const i={},a=void 0,c={},u=[{value:"/service/common/LoginService",id:"servicecommonloginservice",level:3}];function l(e){const r={code:"code",h3:"h3",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.h3,{id:"servicecommonloginservice",children:"/service/common/LoginService"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-java",children:'// \uc804\uccb4 \ucf54\ub4dc\r\n@Slf4j\r\n@Service\r\n@RequiredArgsConstructor\r\npublic class LoginService {\r\n\r\n    private final CustomUserDetailsService customUserDetailsService;\r\n    private final PasswordEncoder passwordEncoder;\r\n    private final UserRepository userRepository;\r\n    private final UserMailService mailService;\r\n    private final RedisTemplate<String, String> redisTemplate;\r\n    private final AuthenticationManager authenticationManager;\r\n    private final SessionRegistry sessionRegistry;\r\n    private final SessionAuthenticationStrategy sessionAuthenticationStrategy;\r\n    private final HttpSessionSecurityContextRepository securityContextRepository;\r\n    private final SecurityContextHolderStrategy securityContextHolderStrategy = SecurityContextHolder.getContextHolderStrategy();\r\n\r\n\r\n    private static final String RESET_REQUIRED_PREFIX = "reset:required:";\r\n\r\n    public UserRole authenticateAndLogin(LoginDto req, HttpServletRequest request, HttpServletResponse response) {\r\n        User user = findUserOrThrow(req.getEmail());\r\n\r\n        validateUserStatus(user);\r\n        verifyPassword(req.getPassword(), user);\r\n        checkFirstLogin(user);\r\n        updateLoginInfo(user);\r\n        performSecurityAuthentication(req, user, request, response);\r\n        checkPasswordResetRequired(user.getEmail());\r\n\r\n        return resolveUserRole(user);\r\n    }\r\n\r\n    private User findUserOrThrow(String email) { // \uc0ac\uc6a9\uc790 \uc870\ud68c\r\n        try {\r\n            return customUserDetailsService.loadUserByUsername(email);\r\n        } catch (Exception ex) {\r\n            throw new CustomException(ErrorCode.INVALID_USERNAME_OR_PASSWORD);\r\n        }\r\n    }\r\n\r\n    private void validateUserStatus(User user) { // \uacc4\uc815 \uc0c1\ud0dc \ud655\uc778\r\n        if (!user.isAccountNonLocked()) {\r\n            throw new CustomException(ErrorCode.ACCOUNT_DISABLED);\r\n        }\r\n    }\r\n\r\n    private void verifyPassword(String rawPassword, User user) { // \ube44\ubc00 \ubc88\ud638 \uac80\uc99d \ubc0f \uc608\uc678\r\n        if (!passwordEncoder.matches(rawPassword, user.getPassword())) {\r\n            user.incrementFailed();\r\n            user.loginFail();\r\n            userRepository.save(user);\r\n            if (user.getFailedCount() >= 5) {\r\n                throw new CustomException(\r\n                        ErrorCode.ACCOUNT_LOCKED);\r\n            }\r\n            throw new CustomException(ErrorCode.INVALID_USERNAME_OR_PASSWORD);\r\n        }\r\n    }\r\n\r\n    private void checkFirstLogin(User user) { // \uccab \ub85c\uadf8\uc778 \ud655\uc778\r\n        if (user.checkFirstLogin()) {\r\n            throw new CustomException(ErrorCode.FIRST_LOGIN_REQUIRED);\r\n        }\r\n    }\r\n\r\n\r\n    private void updateLoginInfo(User user) { // \ub85c\uadf8\uc778 \uc131\uacf5 \ud6c4\uc758 \uc0ac\uc6a9\uc790 \uc815\ubcf4 \uc5c5\ub370\uc774\ud2b8\r\n        user.resetFailedCount();\r\n        user.updateLastLoginAt();\r\n        userRepository.save(user);\r\n        mailService.successLogin(user.getEmail());\r\n    }\r\n\r\n\r\n    private void performSecurityAuthentication(LoginDto req, User user, HttpServletRequest request, HttpServletResponse response) {\r\n        try {\r\n            // 1. \uc778\uc99d \ud1a0\ud070 \uc0dd\uc131 \ubc0f \uc778\uc99d \uc218\ud589\r\n            UsernamePasswordAuthenticationToken authToken =\r\n                    new UsernamePasswordAuthenticationToken(req.getEmail(), req.getPassword(), user.getAuthorities());\r\n\r\n            Authentication authentication = authenticationManager.authenticate(authToken);\r\n            log.debug("[\uc778\uc99d \uc131\uacf5] \uc0ac\uc6a9\uc790: {}", user.getEmail());\r\n\r\n            // 2. \uc138\uc158 \uc815\ucc45 \uc801\uc6a9 (\uc911\ubcf5 \uc138\uc158 \uc81c\uc5b4)\r\n            sessionAuthenticationStrategy.onAuthentication(authentication, request, response);\r\n            log.debug("[\uc138\uc158 \uc815\ucc45 \uc801\uc6a9 \uc644\ub8cc] \uc0ac\uc6a9\uc790: {}", user.getEmail());\r\n\r\n            // 3. SecurityContext \uc124\uc815\r\n\t      SecurityContext context = securityContextHolderStrategy.createEmptyContext();\r\n            context.setAuthentication(authentication);\r\n            SecurityContextHolder.setContext(context);\r\n\r\n            // 4. SecurityContext\ub97c \uc138\uc158\uc5d0 \uc800\uc7a5\r\n            securityContextRepository.saveContext(context, request, response);\r\n\r\n            HttpSession session = request.getSession(false); // \uae30\uc874 \uc138\uc158 \uac00\uc838\uc624\uae30 (\uc0dd\uc131\ud558\uc9c0 \uc54a\uc74c)\r\n            String sessionId = session != null ? session.getId() : "Unknown";\r\n            log.info("[\uc778\uc99d \uc644\ub8cc] \uc0ac\uc6a9\uc790: {}, \uc138\uc158 ID: {}", user.getEmail(), sessionId);\r\n\r\n        } catch (SessionAuthenticationException ex) {\r\n            log.warn("[\uc138\uc158 \uc815\ucc45 \uc704\ubc18] \uc0ac\uc6a9\uc790: {}, \uc774\uc720: {}", user.getEmail(), ex.getMessage());\r\n            // Spring Security\uc758 SessionAuthenticationException\uc744 \ucee4\uc2a4\ud140 \uc608\uc678\ub85c \ubcc0\ud658\r\n            throw new CustomException(ErrorCode.SESSION_ALREADY_EXISTS);\r\n        } catch (Exception ex) {\r\n            log.error("[\uc778\uc99d \uc2e4\ud328] \uc0ac\uc6a9\uc790: {}, \uc774\uc720: {}", user.getEmail(), ex.getMessage(), ex);\r\n            throw new CustomException(ErrorCode.INTERNAL_SERVER_ERROR);\r\n        }\r\n    }\r\n\r\n    // \ube44\ubc00\ubc88\ud638 \uc7ac\uc124\uc815 \ud544\uc694 \uc5ec\ubd80 \ud655\uc778\r\n    private void checkPasswordResetRequired(String email) {\r\n        if ("true".equals(redisTemplate.opsForValue().get(RESET_REQUIRED_PREFIX + email))) {\r\n            throw new CustomException(ErrorCode.RESET_PASSWORD_REQUIRED);\r\n        }\r\n    }\r\n\r\n    // \ube44\ubc00\ubc88\ud638 \uc7ac\uc124\uc815 \ud50c\ub798\uadf8\r\n    private void clearPasswordResetFlag(String email) {\r\n        redisTemplate.delete(RESET_REQUIRED_PREFIX + email);\r\n    }\r\n\r\n    private UserRole resolveUserRole(User user) {\r\n        return (user.getClient() == null) ? UserRole.ADMIN : UserRole.CLIENT;\r\n    }\r\n\r\n    // \uc0ac\uc6a9\uc790 \ube44\ubc00\ubc88\ud638 \ubcc0\uacbd\r\n    @Transactional\r\n    public void updateUserPassword(String email, RequestUpdateUserPasswordDto dto) {\r\n        User user = userRepository.findByEmail(email)\r\n                .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));\r\n\r\n        if (passwordEncoder.matches(dto.getPassword(), user.getPassword())) {\r\n            throw new CustomException(ErrorCode.SAME_AS_OLD_PASSWORD);\r\n        }\r\n\r\n        user.changePassword(passwordEncoder.encode(dto.getPassword()));\r\n        user.updateLastLoginAt();\r\n        clearPasswordResetFlag(email);\r\n    }\r\n}\n'})})]})}function d(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453(e,r,t){t.d(r,{R:()=>i,x:()=>a});var n=t(6540);const o={},s=n.createContext(o);function i(e){const r=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(s.Provider,{value:r},e.children)}}}]);