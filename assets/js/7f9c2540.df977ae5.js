"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[7911],{8453(e,n,i){i.d(n,{R:()=>t,x:()=>d});var r=i(6540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}},9574(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>t,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"projects/bargain-hunter/troubleshooting/redis-concurrency","title":"\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0","description":"Redis Hash + \uc6d0\uc790\uc801 \uc5f0\uc0b0(HINCRBY)\uc744 \ud65c\uc6a9\ud558\uc5ec","source":"@site/docs/projects/bargain-hunter/troubleshooting/redis-concurrency.md","sourceDirName":"projects/bargain-hunter/troubleshooting","slug":"/projects/bargain-hunter/troubleshooting/redis-concurrency","permalink":"/docs/projects/bargain-hunter/troubleshooting/redis-concurrency","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0"},"sidebar":"tutorialSidebar","previous":{"title":"\uc774\uba54\uc77c \ubc1c\uc1a1 \ube44\ub3d9\uae30 \ucc98\ub9ac (92% \uac1c\uc120)","permalink":"/docs/projects/bargain-hunter/troubleshooting/email-async"},"next":{"title":"Refresh Token \uad00\ub9ac \uc804\ub7b5","permalink":"/docs/projects/bargain-hunter/troubleshooting/refresh-token"}}');var s=i(4848),l=i(8453);const t={sidebar_position:2,title:"\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0"},d="\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0",c={},o=[{value:"0. \uac1c\uc694",id:"0-\uac1c\uc694",level:2},{value:"1. \ubb38\uc81c \ubd84\uc11d",id:"1-\ubb38\uc81c-\ubd84\uc11d",level:2},{value:"AS-IS: \ubd84\ub9ac\ub41c Key \uad6c\uc870",id:"as-is-\ubd84\ub9ac\ub41c-key-\uad6c\uc870",level:3},{value:"\uc778\uc99d \ub85c\uc9c1 \ud750\ub984 (\ubb38\uc81c \ubc1c\uc0dd)",id:"\uc778\uc99d-\ub85c\uc9c1-\ud750\ub984-\ubb38\uc81c-\ubc1c\uc0dd",level:3},{value:"\u274c \ubb38\uc81c\uc810",id:"-\ubb38\uc81c\uc810",level:3},{value:"2. \ud574\uacb0 \uacfc\uc815",id:"2-\ud574\uacb0-\uacfc\uc815",level:2},{value:"Step 1: Redis Hash \uad6c\uc870 \uc124\uacc4",id:"step-1-redis-hash-\uad6c\uc870-\uc124\uacc4",level:3},{value:"Step 2: \uc778\uc99d \ucf54\ub4dc \uc800\uc7a5",id:"step-2-\uc778\uc99d-\ucf54\ub4dc-\uc800\uc7a5",level:3},{value:"Step 3: \uc778\uc99d \uac80\uc99d + \uc2dc\ub3c4 \ud69f\uc218 \uc6d0\uc790\uc801 \uc99d\uac00",id:"step-3-\uc778\uc99d-\uac80\uc99d--\uc2dc\ub3c4-\ud69f\uc218-\uc6d0\uc790\uc801-\uc99d\uac00",level:3},{value:"3. TO-BE \uc544\ud0a4\ud14d\ucc98",id:"3-to-be-\uc544\ud0a4\ud14d\ucc98",level:2},{value:"4. \ud575\uc2ec \uac1c\uc120 \ud3ec\uc778\ud2b8",id:"4-\ud575\uc2ec-\uac1c\uc120-\ud3ec\uc778\ud2b8",level:2},{value:"5. \uc131\uacfc",id:"5-\uc131\uacfc",level:2}];function h(e){const n={admonition:"admonition",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\uc774\uba54\uc77c-\uc778\uc99d-\ub3d9\uc2dc\uc131-\ubb38\uc81c-\ud574\uacb0",children:"\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Redis Hash + \uc6d0\uc790\uc801 \uc5f0\uc0b0(HINCRBY)\uc744 \ud65c\uc6a9\ud558\uc5ec",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.strong,{children:"\ub3d9\uc2dc \uc694\uccad \ud658\uacbd\uc5d0\uc11c\ub3c4 \uc778\uc99d \uc2dc\ub3c4 \ud69f\uc218 \uc815\ud655\uc131 \ubcf4\uc7a5"})]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"0-\uac1c\uc694",children:"0. \uac1c\uc694"}),"\n",(0,s.jsx)(n.admonition,{title:"\ubb38\uc81c \uc0c1\ud669",type:"danger",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\uc774\uba54\uc77c \uc778\uc99d \ucf54\ub4dc ",(0,s.jsx)(n.strong,{children:"\ucd5c\ub300 5\ud68c \uc2dc\ub3c4 \uc81c\ud55c"})," \uc694\uad6c\uc0ac\ud56d"]}),"\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc\uc5d0 \uc5ec\ub7ec \uc778\uc99d \uc694\uccad\uc774 \ub4e4\uc5b4\uc62c \uc218 \uc788\ub294 \ud658\uacbd"}),"\n",(0,s.jsxs)(n.li,{children:["\uae30\uc874 \uad6c\uc870\uc5d0\uc11c ",(0,s.jsx)(n.strong,{children:"Race Condition \ubc1c\uc0dd"})]}),"\n",(0,s.jsx)(n.li,{children:"\uc2dc\ub3c4 \ud69f\uc218\uac00 \uc815\ud655\ud788 \uce74\uc6b4\ud305\ub418\uc9c0 \uc54a\ub294 \ubb38\uc81c \ubc1c\uc0dd"}),"\n"]})}),"\n",(0,s.jsx)(n.admonition,{title:"\ud574\uacb0 \ubc29\ud5a5",type:"tip",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Redis ",(0,s.jsx)(n.strong,{children:"Hash \uad6c\uc870"}),"\ub85c \uc778\uc99d \uc815\ubcf4 \ud1b5\ud569 \uad00\ub9ac"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"HINCRBY"}),"\ub97c \ud65c\uc6a9\ud55c ",(0,s.jsx)(n.strong,{children:"\uc6d0\uc790\uc801 \uc2dc\ub3c4 \ud69f\uc218 \uc99d\uac00"})]}),"\n",(0,s.jsx)(n.li,{children:"TTL \uc801\uc6a9\uc73c\ub85c \uc790\ub3d9 \ub9cc\ub8cc \ubc0f \uba54\ubaa8\ub9ac \uad00\ub9ac"}),"\n"]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"1-\ubb38\uc81c-\ubd84\uc11d",children:"1. \ubb38\uc81c \ubd84\uc11d"}),"\n",(0,s.jsx)(n.h3,{id:"as-is-\ubd84\ub9ac\ub41c-key-\uad6c\uc870",children:"AS-IS: \ubd84\ub9ac\ub41c Key \uad6c\uc870"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"code:{email}     \u2192 \uc778\uc99d \ucf54\ub4dc\r\nattempt:{email}  \u2192 \uc2dc\ub3c4 \ud69f\uc218\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\uc778\uc99d-\ub85c\uc9c1-\ud750\ub984-\ubb38\uc81c-\ubc1c\uc0dd",children:"\uc778\uc99d \ub85c\uc9c1 \ud750\ub984 (\ubb38\uc81c \ubc1c\uc0dd)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"GET code"}),"\n",(0,s.jsx)(n.li,{children:"\ucf54\ub4dc \ube44\uad50"}),"\n",(0,s.jsx)(n.li,{children:"GET attemptCount"}),"\n",(0,s.jsx)(n.li,{children:"SET attemptCount + 1"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-\ubb38\uc81c\uc810",children:"\u274c \ubb38\uc81c\uc810"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\ub450 Key \uac04 \ub370\uc774\ud130 \uc77c\uad00\uc131 \uae68\uc9d0","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"code\ub294 \uc874\uc7ac\ud558\uc9c0\ub9cc attemptCount\uac00 \uc5c6\ub294 \uacbd\uc6b0 \ubc1c\uc0dd"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["GET \u2192 SET \uc0ac\uc774 Race Condition","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc\uc5d0 \uc694\uccad \uc2dc \uc2dc\ub3c4 \ud69f\uc218 \ub204\ub77d"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc \uc694\uccad\uc774 \ub9ce\uc744\uc218\ub85d \uc81c\ud55c \ud69f\uc218 \ucd08\uacfc \ud5c8\uc6a9 \uac00\ub2a5\uc131 \uc99d\uac00"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"2-\ud574\uacb0-\uacfc\uc815",children:"2. \ud574\uacb0 \uacfc\uc815"}),"\n",(0,s.jsx)(n.h3,{id:"step-1-redis-hash-\uad6c\uc870-\uc124\uacc4",children:"Step 1: Redis Hash \uad6c\uc870 \uc124\uacc4"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"verification:{type}:{email}\r\n \u251c\u2500 code: \uc778\uc99d \ucf54\ub4dc\r\n \u2514\u2500 attemptCount: \uc2dc\ub3c4 \ud69f\uc218\r\n (TTL: 5\ubd84)\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\uc778\uc99d \ucf54\ub4dc\uc640 \uc2dc\ub3c4 \ud69f\uc218\ub97c \ud558\ub098\uc758 Key\ub85c \ubb36\uc5b4 \uad00\ub9ac"}),"\n",(0,s.jsx)(n.li,{children:"\ub370\uc774\ud130 \uc815\ud569\uc131 \ubb38\uc81c \uadfc\ubcf8\uc801 \ud574\uacb0"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-2-\uc778\uc99d-\ucf54\ub4dc-\uc800\uc7a5",children:"Step 2: \uc778\uc99d \ucf54\ub4dc \uc800\uc7a5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public void saveCode(String email, String code, VerificationType type) {\r\n    String key = buildKey(email, type);\r\n\r\n    Map<String, String> data = new HashMap<>();\r\n    data.put("code", code);\r\n    data.put("attemptCount", "0");\r\n\r\n    stringRedisTemplate.opsForHash().putAll(key, data);\r\n    stringRedisTemplate.expire(key, Duration.ofMinutes(5)); // TTL 5\ubd84\r\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\ud3ec\uc778\ud2b8"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Hash \uad6c\uc870\ub85c \uc778\uc99d \uc815\ubcf4 \ud1b5\ud569"}),"\n",(0,s.jsx)(n.li,{children:"TTL \uc801\uc6a9\uc73c\ub85c \ub9cc\ub8cc \uc790\ub3d9 \ucc98\ub9ac"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-3-\uc778\uc99d-\uac80\uc99d--\uc2dc\ub3c4-\ud69f\uc218-\uc6d0\uc790\uc801-\uc99d\uac00",children:"Step 3: \uc778\uc99d \uac80\uc99d + \uc2dc\ub3c4 \ud69f\uc218 \uc6d0\uc790\uc801 \uc99d\uac00"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public void verifyCode(String email, String inputCode, VerificationType type) {\r\n    String key = buildKey(email, type);\r\n\r\n    // 1. \ucf54\ub4dc \uc870\ud68c\r\n    String savedCode = (String) stringRedisTemplate.opsForHash().get(key, "code");\r\n\r\n    if (savedCode.equals(inputCode)) {\r\n        stringRedisTemplate.delete(key);\r\n        return; // \uc778\uc99d \uc131\uacf5\r\n    }\r\n\r\n    // 2. \uc2dc\ub3c4 \ud69f\uc218 \uc6d0\uc790\uc801 \uc99d\uac00\r\n    Long newAttemptCount = stringRedisTemplate.opsForHash()\r\n        .increment(key, "attemptCount", 1);\r\n\r\n    if (newAttemptCount > 5) {\r\n        stringRedisTemplate.delete(key);\r\n        throw new InvalidCodeException("\uc778\uc99d \uc2dc\ub3c4 \ud69f\uc218 \ucd08\uacfc");\r\n    }\r\n\r\n    int remaining = 5 - newAttemptCount.intValue();\r\n    throw new InvalidCodeException(\r\n        "\uc778\uc99d\ucf54\ub4dc \ubd88\uc77c\uce58 (\ub0a8\uc740 \uc2dc\ub3c4: " + remaining + "\ud68c)"\r\n    );\r\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"\ud575\uc2ec \ud3ec\uc778\ud2b8"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"HINCRBY \u2192 \uc6d0\uc790\uc801 \uc5f0\uc0b0"}),"\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc \uc694\uccad\uc5d0\uc11c\ub3c4 \uc2dc\ub3c4 \ud69f\uc218 \uc815\ud655\ud788 \uc99d\uac00"}),"\n",(0,s.jsx)(n.li,{children:"\ubcc4\ub3c4\uc758 Lock \uc5c6\uc774 \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-to-be-\uc544\ud0a4\ud14d\ucc98",children:"3. TO-BE \uc544\ud0a4\ud14d\ucc98"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"[Client \uc694\uccad]\r\n     \u2193\r\n[VerificationService]\r\n     \u2193\r\n[Redis Hash \uc870\ud68c]\r\n \u251c\u2500 code \ube44\uad50\r\n \u2514\u2500 HINCRBY(attemptCount) \u2190 \uc6d0\uc790\uc801 \ucc98\ub9ac\r\n     \u2193\r\n[\uc131\uacf5 \u2192 Key \uc0ad\uc81c]\r\n[\uc2e4\ud328 \u2192 \ub0a8\uc740 \ud69f\uc218 \ubc18\ud658]\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"4-\ud575\uc2ec-\uac1c\uc120-\ud3ec\uc778\ud2b8",children:"4. \ud575\uc2ec \uac1c\uc120 \ud3ec\uc778\ud2b8"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"1\ufe0f\u20e3 \ub370\uc774\ud130 \uc77c\uad00\uc131 \ud655\ubcf4"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\ucf54\ub4dc / \uc2dc\ub3c4 \ud69f\uc218\ub97c \ud558\ub098\uc758 Hash Key\ub85c \uad00\ub9ac"}),"\n",(0,s.jsx)(n.li,{children:"\ubd80\ubd84 \ub370\uc774\ud130 \uc720\uc2e4 \ubb38\uc81c \uc81c\uac70"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"2\ufe0f\u20e3 \ub3d9\uc2dc\uc131 \uc548\uc804\uc131 \ud655\ubcf4"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"HINCRBY \uc0ac\uc6a9\uc73c\ub85c Race Condition \uc81c\uac70"}),"\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc \uc694\uccad \uc0c1\ud669\uc5d0\uc11c\ub3c4 \uc815\ud655\ud55c \ud69f\uc218 \uc81c\ud55c \ubcf4\uc7a5"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"3\ufe0f\u20e3 Redis \uba54\ubaa8\ub9ac \ud6a8\uc728 \uac1c\uc120"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"TTL \uc790\ub3d9 \ub9cc\ub8cc \uc801\uc6a9"}),"\n",(0,s.jsx)(n.li,{children:"\ubd88\ud544\uc694\ud55c \uc778\uc99d \ub370\uc774\ud130 \uc794\uc874 \ubc29\uc9c0"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"5-\uc131\uacfc",children:"5. \uc131\uacfc"}),"\n",(0,s.jsx)(n.admonition,{title:"\uc131\uacfc",type:"success",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc \uc778\uc99d \uc694\uccad \ud658\uacbd\uc5d0\uc11c\ub3c4 \uc2dc\ub3c4 \ud69f\uc218 \uc815\ud655\uc131 100% \ubcf4\uc7a5"}),"\n",(0,s.jsx)(n.li,{children:"Race Condition \uc644\uc804 \uc81c\uac70"}),"\n",(0,s.jsx)(n.li,{children:"\uc778\uc99d \uc2e4\ud328/\uc131\uacf5 \ud750\ub984 \ub2e8\uc21c\ud654"}),"\n",(0,s.jsx)(n.li,{children:"Redis Key \uad6c\uc870 \uac04\uacb0\ud654 \ubc0f \uc720\uc9c0\ubcf4\uc218\uc131 \ud5a5\uc0c1"}),"\n"]})}),"\n",(0,s.jsx)(n.admonition,{title:"\ubc30\uc6b4 \uc810",type:"tip",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\ub3d9\uc2dc\uc131 \ubb38\uc81c\ub294 \ub85c\uc9c1\uc774 \uc544\ub2cc \uc790\ub8cc\uad6c\uc870 \uc120\ud0dd\uc5d0\uc11c \ud574\uacb0 \uac00\ub2a5"}),"\n",(0,s.jsx)(n.li,{children:"Redis \uc6d0\uc790\uc801 \uc5f0\uc0b0\uc758 \uc911\uc694\uc131 \uccb4\uac10"}),"\n",(0,s.jsx)(n.li,{children:"\ubd84\uc0b0 \ud658\uacbd\uc5d0\uc11c\ub294 \u201c\uc77d\uace0-\uc218\uc815\u201d\ubcf4\ub2e4 \u201c\ud55c \ubc88\uc5d0 \ucc98\ub9ac\u201d\uac00 \ud575\uc2ec"}),"\n"]})})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);