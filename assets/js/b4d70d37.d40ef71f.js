"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[4788],{5506(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>a,frontMatter:()=>l,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"projects/bargain-hunter/troubleshooting/refresh-token","title":"Refresh Token \uad00\ub9ac \uc804\ub7b5","description":"Redis vs PostgreSQL \ube44\uad50 \ubc0f \ubcf4\uc548 \uac15\ud654","source":"@site/docs/projects/bargain-hunter/troubleshooting/refresh-token.md","sourceDirName":"projects/bargain-hunter/troubleshooting","slug":"/projects/bargain-hunter/troubleshooting/refresh-token","permalink":"/docs/projects/bargain-hunter/troubleshooting/refresh-token","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Refresh Token \uad00\ub9ac \uc804\ub7b5"},"sidebar":"tutorialSidebar","previous":{"title":"\uc774\uba54\uc77c \uc778\uc99d \ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0","permalink":"/docs/projects/bargain-hunter/troubleshooting/redis-concurrency"},"next":{"title":"Security Ticket Platform","permalink":"/docs/projects/security-ticket/"}}');var i=r(4848),o=r(8453);const l={sidebar_position:3,title:"Refresh Token \uad00\ub9ac \uc804\ub7b5"},t="Refresh Token DB \uc800\uc7a5 \uc804\ub7b5",d={},h=[{value:"0. \uac1c\uc694",id:"0-\uac1c\uc694",level:2},{value:"1. Redis vs DB \ube44\uad50",id:"1-redis-vs-db-\ube44\uad50",level:2},{value:"2. DB \uc2a4\ud0a4\ub9c8 \uc124\uacc4",id:"2-db-\uc2a4\ud0a4\ub9c8-\uc124\uacc4",level:2},{value:"RefreshToken \uc5d4\ud2f0\ud2f0",id:"refreshtoken-\uc5d4\ud2f0\ud2f0",level:3},{value:"3. \ud1a0\ud070 \uc0dd\uc131 \ub85c\uc9c1",id:"3-\ud1a0\ud070-\uc0dd\uc131-\ub85c\uc9c1",level:2},{value:"4. \ud1a0\ud070 \uac31\uc2e0 \ub85c\uc9c1",id:"4-\ud1a0\ud070-\uac31\uc2e0-\ub85c\uc9c1",level:2},{value:"5. \ub85c\uadf8\uc544\uc6c3 \ub85c\uc9c1",id:"5-\ub85c\uadf8\uc544\uc6c3-\ub85c\uc9c1",level:2},{value:"6. \ud1a0\ud070 \ud0c8\ucde8 \ub300\uc751",id:"6-\ud1a0\ud070-\ud0c8\ucde8-\ub300\uc751",level:2},{value:"\uc2dc\ub098\ub9ac\uc624: Refresh Token \ud0c8\ucde8 \uac10\uc9c0",id:"\uc2dc\ub098\ub9ac\uc624-refresh-token-\ud0c8\ucde8-\uac10\uc9c0",level:3},{value:"7. \ub9cc\ub8cc \ud1a0\ud070 \uc815\ub9ac (\uc2a4\ucf00\uc904\ub7ec)",id:"7-\ub9cc\ub8cc-\ud1a0\ud070-\uc815\ub9ac-\uc2a4\ucf00\uc904\ub7ec",level:2},{value:"8. \ubcf4\uc548 \uac15\ud654 \ud3ec\uc778\ud2b8",id:"8-\ubcf4\uc548-\uac15\ud654-\ud3ec\uc778\ud2b8",level:2},{value:"1\ufe0f\u20e3 \ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778",id:"1\ufe0f\u20e3-\ub2e8\uc77c-\uae30\uae30-\ub85c\uadf8\uc778",level:3},{value:"2\ufe0f\u20e3 \ud1a0\ud070 \uc7ac\uc0ac\uc6a9 \uac10\uc9c0",id:"2\ufe0f\u20e3-\ud1a0\ud070-\uc7ac\uc0ac\uc6a9-\uac10\uc9c0",level:3},{value:"3\ufe0f\u20e3 Access Token \uc9e7\uc740 \ub9cc\ub8cc \uc2dc\uac04",id:"3\ufe0f\u20e3-access-token-\uc9e7\uc740-\ub9cc\ub8cc-\uc2dc\uac04",level:3},{value:"9. \uacb0\ub860",id:"9-\uacb0\ub860",level:2},{value:"10. \ucd94\uac00 \uace0\ub824\uc0ac\ud56d",id:"10-\ucd94\uac00-\uace0\ub824\uc0ac\ud56d",level:2},{value:"\ub85c\uadf8 \ubd84\uc11d",id:"\ub85c\uadf8-\ubd84\uc11d",level:3},{value:"11. \ucc38\uace0 \uc790\ub8cc",id:"11-\ucc38\uace0-\uc790\ub8cc",level:2}];function c(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"refresh-token-db-\uc800\uc7a5-\uc804\ub7b5",children:"Refresh Token DB \uc800\uc7a5 \uc804\ub7b5"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Redis vs PostgreSQL \ube44\uad50 \ubc0f \ubcf4\uc548 \uac15\ud654"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"0-\uac1c\uc694",children:"0. \uac1c\uc694"}),"\n",(0,i.jsx)(n.admonition,{title:"\ubb38\uc81c \uc0c1\ud669",type:"danger",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ub85c\uadf8\uc544\uc6c3 \uc2dc Refresh Token \uc989\uc2dc \ubb34\ud6a8\ud654"})," \ud544\uc694"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778"})," \uc9c0\uc6d0 \ud544\uc694"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ud0c8\ucde8\ub41c \ud1a0\ud070 \uac10\uc9c0 \ubc0f \ud3d0\uae30"})," \ud544\uc694"]}),"\n"]})}),"\n",(0,i.jsx)(n.admonition,{title:"\ud574\uacb0 \ubc29\ud5a5",type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Refresh Token\uc744 ",(0,i.jsx)(n.strong,{children:"PostgreSQL\uc5d0 \uc800\uc7a5"})]}),"\n",(0,i.jsx)(n.li,{children:"\ub85c\uadf8\uc544\uc6c3 \uc2dc DB\uc5d0\uc11c \uc989\uc2dc \uc0ad\uc81c"}),"\n",(0,i.jsx)(n.li,{children:"\ud1a0\ud070 \ud0c8\ucde8 \uac10\uc9c0 \uc2dc \ud574\ub2f9 \uc0ac\uc6a9\uc790\uc758 \ubaa8\ub4e0 \ud1a0\ud070 \ubb34\ud6a8\ud654 \uac00\ub2a5"}),"\n"]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"1-redis-vs-db-\ube44\uad50",children:"1. Redis vs DB \ube44\uad50"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\ud56d\ubaa9"}),(0,i.jsx)(n.th,{children:"Redis \uc800\uc7a5"}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.strong,{children:"PostgreSQL (\ucc44\ud0dd)"})})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\ub85c\uadf8\uc544\uc6c3 \uc989\uc2dc \ubb34\ud6a8\ud654"})}),(0,i.jsx)(n.td,{children:"\u274c TTL \ub9cc\ub8cc \ub300\uae30"}),(0,i.jsx)(n.td,{children:"\u2705 \uc989\uc2dc DELETE"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\ub85c\uadf8 \ucd94\uc801"})}),(0,i.jsx)(n.td,{children:"\u274c \ud718\ubc1c\uc131 \ub370\uc774\ud130"}),(0,i.jsx)(n.td,{children:"\u2705 \uc601\uad6c \uc800\uc7a5"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778"})}),(0,i.jsx)(n.td,{children:"\u25b3 (Key \ub36e\uc5b4\uc4f0\uae30)"}),(0,i.jsx)(n.td,{children:"\u2705 (userId \uae30\uc900 \uc0ad\uc81c \ud6c4 \uc800\uc7a5)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\ud1a0\ud070 \ud0c8\ucde8 \ub300\uc751"})}),(0,i.jsx)(n.td,{children:"\u25b3 (\uac1c\ubcc4 \uc0ad\uc81c)"}),(0,i.jsx)(n.td,{children:"\u2705 (userId \uae30\uc900 \uc804\uccb4 \uc0ad\uc81c)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\ub9cc\ub8cc \ucc98\ub9ac"})}),(0,i.jsx)(n.td,{children:"\u2705 TTL \uc790\ub3d9"}),(0,i.jsx)(n.td,{children:"\u25b3 (\uc2a4\ucf00\uc904\ub7ec \ud544\uc694)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\uc131\ub2a5"})}),(0,i.jsx)(n.td,{children:"\u2705 \ube60\ub984"}),(0,i.jsx)(n.td,{children:"\u25b3 (DB I/O \ubc1c\uc0dd)"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\uc120\ud0dd \uc774\uc720"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ubcf4\uc548\uc774 \uc911\uc694\ud55c \uc778\uc99d \uc11c\ube44\uc2a4 \ud2b9\uc131\uc0c1 ",(0,i.jsx)(n.strong,{children:"\ub85c\uadf8 \ucd94\uc801 \ubc0f \uc989\uc2dc \ubb34\ud6a8\ud654"}),"\uac00 \uc6b0\uc120"]}),"\n",(0,i.jsxs)(n.li,{children:["Refresh Token \uc870\ud68c \ube48\ub3c4\uac00 \ub0ae\uc544 ",(0,i.jsx)(n.strong,{children:"DB I/O \ubd80\ub2f4 \uc801\uc74c"})]}),"\n",(0,i.jsx)(n.li,{children:"\uc2a4\ucf00\uc904\ub7ec\ub85c \ub9cc\ub8cc \ud1a0\ud070 \uc815\ub9ac \uac00\ub2a5"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"2-db-\uc2a4\ud0a4\ub9c8-\uc124\uacc4",children:"2. DB \uc2a4\ud0a4\ub9c8 \uc124\uacc4"}),"\n",(0,i.jsx)(n.h3,{id:"refreshtoken-\uc5d4\ud2f0\ud2f0",children:"RefreshToken \uc5d4\ud2f0\ud2f0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Entity\r\n@Table(name = "refresh_tokens")\r\npublic class RefreshToken {\r\n\r\n    @Id\r\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n    private Long id;\r\n\r\n    @Column(nullable = false)\r\n    private Long userId;\r\n\r\n    @Column(nullable = false, unique = true, length = 500)\r\n    private String token;\r\n\r\n    @Column(nullable = false)\r\n    private LocalDateTime expiryDate;\r\n\r\n    @Column(nullable = false)\r\n    private LocalDateTime createdAt;\r\n\r\n    // \ud1a0\ud070 \uc0dd\uc131 \uba54\uc11c\ub4dc\r\n    public static RefreshToken create(Long userId, String token, Date expiryDate) {\r\n        RefreshToken refreshToken = new RefreshToken();\r\n        refreshToken.userId = userId;\r\n        refreshToken.token = token;\r\n        refreshToken.expiryDate = LocalDateTime.ofInstant(\r\n            expiryDate.toInstant(),\r\n            ZoneId.systemDefault()\r\n        );\r\n        refreshToken.createdAt = LocalDateTime.now();\r\n        return refreshToken;\r\n    }\r\n\r\n    // \ub9cc\ub8cc \ud655\uc778 \uba54\uc11c\ub4dc\r\n    public boolean isExpired() {\r\n        return LocalDateTime.now().isAfter(expiryDate);\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"3-\ud1a0\ud070-\uc0dd\uc131-\ub85c\uc9c1",children:"3. \ud1a0\ud070 \uc0dd\uc131 \ub85c\uc9c1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\r\n@Transactional\r\npublic class TokenService {\r\n\r\n    private final RefreshTokenRepository refreshTokenRepository;\r\n    private final JwtTokenProvider jwtTokenProvider;\r\n\r\n    public TokenPair generateTokens(User user) {\r\n        // 1. \uae30\uc874 \ud1a0\ud070 \uc0ad\uc81c (\ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778)\r\n        refreshTokenRepository.deleteByUserId(user.getId());\r\n\r\n        // 2. \uc0c8 \ud1a0\ud070 \uc0dd\uc131\r\n        Token accessToken = jwtTokenProvider.generateAccessToken(\r\n            user.getId(),\r\n            user.getEmail(),\r\n            user.getRole()\r\n        );\r\n\r\n        Token refreshToken = jwtTokenProvider.generateRefreshToken(\r\n            user.getId()\r\n        );\r\n\r\n        // 3. Refresh Token DB \uc800\uc7a5\r\n        RefreshToken tokenEntity = RefreshToken.create(\r\n            user.getId(),\r\n            refreshToken.getToken(),\r\n            Date.from(refreshToken.getTokenExpiry())\r\n        );\r\n        refreshTokenRepository.save(tokenEntity);\r\n\r\n        log.info("\ud1a0\ud070 \uc0dd\uc131 \uc644\ub8cc: userId={}", user.getId());\r\n\r\n        return new TokenPair(accessToken, refreshToken);\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \ud3ec\uc778\ud2b8"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.code,{children:"deleteByUserId()"}),"\ub85c \uae30\uc874 \ud1a0\ud070 \uc0ad\uc81c \u2192 ",(0,i.jsx)(n.strong,{children:"\ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778"})," \ubcf4\uc7a5"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 Refresh Token\uc744 DB\uc5d0 \uc800\uc7a5 \u2192 ",(0,i.jsx)(n.strong,{children:"\ub85c\uadf8 \ucd94\uc801"})," \uac00\ub2a5"]}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \ud2b8\ub79c\uc7ad\uc158\uc73c\ub85c \uc0ad\uc81c \u2192 \uc800\uc7a5 \uc6d0\uc790\uc131 \ubcf4\uc7a5"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"4-\ud1a0\ud070-\uac31\uc2e0-\ub85c\uc9c1",children:"4. \ud1a0\ud070 \uac31\uc2e0 \ub85c\uc9c1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\r\n@Transactional\r\npublic class TokenService {\r\n\r\n    public TokenPair refreshAccessToken(String refreshTokenStr) {\r\n        // 1. Refresh Token \uac80\uc99d\r\n        Claims claims = jwtTokenProvider.validateToken(refreshTokenStr);\r\n        Long userId = Long.parseLong(claims.getSubject());\r\n\r\n        // 2. DB\uc5d0\uc11c Refresh Token \uc870\ud68c\r\n        RefreshToken refreshToken = refreshTokenRepository\r\n            .findByToken(refreshTokenStr)\r\n            .orElseThrow(() -> new InvalidTokenException("Refresh Token\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."));\r\n\r\n        // 3. \ub9cc\ub8cc \ud655\uc778\r\n        if (refreshToken.isExpired()) {\r\n            refreshTokenRepository.delete(refreshToken);\r\n            throw new InvalidTokenException("Refresh Token\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");\r\n        }\r\n\r\n        // 4. \uc0ac\uc6a9\uc790 \uc870\ud68c\r\n        User user = userRepository.findById(userId)\r\n            .orElseThrow(() -> new UserNotFoundException("\uc0ac\uc6a9\uc790\ub97c \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."));\r\n\r\n        // 5. \uc0c8 Access Token \uc0dd\uc131\r\n        Token newAccessToken = jwtTokenProvider.generateAccessToken(\r\n            user.getId(),\r\n            user.getEmail(),\r\n            user.getRole()\r\n        );\r\n\r\n        log.info("Access Token \uac31\uc2e0 \uc644\ub8cc: userId={}", userId);\r\n\r\n        return new TokenPair(newAccessToken, new Token(refreshTokenStr, refreshToken.getExpiryDate()));\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \ud3ec\uc778\ud2b8"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2705 DB\uc5d0\uc11c Refresh Token \uc870\ud68c \u2192 ",(0,i.jsx)(n.strong,{children:"\ud0c8\ucde8\ub41c \ud1a0\ud070 \uac10\uc9c0 \uac00\ub2a5"})]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 \ub9cc\ub8cc\ub41c \ud1a0\ud070\uc740 \uc989\uc2dc \uc0ad\uc81c \u2192 ",(0,i.jsx)(n.strong,{children:"DB \uc6a9\ub7c9 \uad00\ub9ac"})]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 Refresh Token\uc740 \uc7ac\uc0ac\uc6a9 \u2192 ",(0,i.jsx)(n.strong,{children:"\ubd88\ud544\uc694\ud55c \uc5c5\ub370\uc774\ud2b8 \ubc29\uc9c0"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"5-\ub85c\uadf8\uc544\uc6c3-\ub85c\uc9c1",children:"5. \ub85c\uadf8\uc544\uc6c3 \ub85c\uc9c1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\r\n@Transactional\r\npublic class AuthService {\r\n\r\n    public void logout(String refreshTokenStr) {\r\n        // Refresh Token DB\uc5d0\uc11c \uc989\uc2dc \uc0ad\uc81c\r\n        RefreshToken refreshToken = refreshTokenRepository\r\n            .findByToken(refreshTokenStr)\r\n            .orElseThrow(() -> new InvalidTokenException("Refresh Token\uc774 \uc874\uc7ac\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."));\r\n\r\n        refreshTokenRepository.delete(refreshToken);\r\n\r\n        log.info("\ub85c\uadf8\uc544\uc6c3 \uc644\ub8cc: userId={}", refreshToken.getUserId());\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \ud3ec\uc778\ud2b8"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2705 DB\uc5d0\uc11c \uc989\uc2dc \uc0ad\uc81c \u2192 ",(0,i.jsx)(n.strong,{children:"\uc7ac\uc0ac\uc6a9 \ubd88\uac00"})]}),"\n",(0,i.jsx)(n.li,{children:"\u2705 Access Token\uc740 \ub9cc\ub8cc\uae4c\uc9c0 \uc720\ud6a8 (\uc9e7\uc740 \ub9cc\ub8cc \uc2dc\uac04 \uad8c\uc7a5: 1\uc2dc\uac04)"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"6-\ud1a0\ud070-\ud0c8\ucde8-\ub300\uc751",children:"6. \ud1a0\ud070 \ud0c8\ucde8 \ub300\uc751"}),"\n",(0,i.jsx)(n.h3,{id:"\uc2dc\ub098\ub9ac\uc624-refresh-token-\ud0c8\ucde8-\uac10\uc9c0",children:"\uc2dc\ub098\ub9ac\uc624: Refresh Token \ud0c8\ucde8 \uac10\uc9c0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\r\n@Transactional\r\npublic class SecurityService {\r\n\r\n    public void invalidateAllTokens(Long userId) {\r\n        // \ud574\ub2f9 \uc0ac\uc6a9\uc790\uc758 \ubaa8\ub4e0 Refresh Token \uc0ad\uc81c\r\n        int deletedCount = refreshTokenRepository.deleteByUserId(userId);\r\n\r\n        log.warn("\ubcf4\uc548 \uc704\ud611 \uac10\uc9c0 - \ubaa8\ub4e0 \ud1a0\ud070 \ubb34\ud6a8\ud654: userId={}, deletedCount={}",\r\n                 userId, deletedCount);\r\n\r\n        // \uc0ac\uc6a9\uc790\uc5d0\uac8c \uc54c\ub9bc \ubc1c\uc1a1\r\n        notificationService.sendSecurityAlert(userId, "\ube44\uc815\uc0c1\uc801\uc778 \ub85c\uadf8\uc778\uc774 \uac10\uc9c0\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud65c\uc6a9 \uc608\uc2dc"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\ube44\uc815\uc0c1\uc801\uc778 \uc704\uce58\uc5d0\uc11c \ub85c\uadf8\uc778 \uc2dc\ub3c4"}),"\n",(0,i.jsx)(n.li,{children:"\uc9e7\uc740 \uc2dc\uac04\uc5d0 \uc5ec\ub7ec \uae30\uae30\uc5d0\uc11c \ub85c\uadf8\uc778 \uc2dc\ub3c4"}),"\n",(0,i.jsx)(n.li,{children:"\uad00\ub9ac\uc790\uac00 \uc218\ub3d9\uc73c\ub85c \uacc4\uc815 \ubcf4\uc548 \uac15\ud654 \ud544\uc694 \uc2dc"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"7-\ub9cc\ub8cc-\ud1a0\ud070-\uc815\ub9ac-\uc2a4\ucf00\uc904\ub7ec",children:"7. \ub9cc\ub8cc \ud1a0\ud070 \uc815\ub9ac (\uc2a4\ucf00\uc904\ub7ec)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Component\r\npublic class TokenCleanupScheduler {\r\n\r\n    private final RefreshTokenRepository refreshTokenRepository;\r\n\r\n    // \ub9e4\uc77c \uc0c8\ubcbd 3\uc2dc \uc2e4\ud589\r\n    @Scheduled(cron = "0 0 3 * * *")\r\n    @Transactional\r\n    public void deleteExpiredTokens() {\r\n        LocalDateTime now = LocalDateTime.now();\r\n        int deletedCount = refreshTokenRepository.deleteByExpiryDateBefore(now);\r\n\r\n        log.info("\ub9cc\ub8cc \ud1a0\ud070 \uc815\ub9ac \uc644\ub8cc: deletedCount={}", deletedCount);\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// Repository\r\npublic interface RefreshTokenRepository extends JpaRepository {\r\n\r\n    Optional findByToken(String token);\r\n\r\n    @Modifying\r\n    @Query("DELETE FROM RefreshToken rt WHERE rt.userId = :userId")\r\n    int deleteByUserId(@Param("userId") Long userId);\r\n\r\n    @Modifying\r\n    @Query("DELETE FROM RefreshToken rt WHERE rt.expiryDate < :now")\r\n    int deleteByExpiryDateBefore(@Param("now") LocalDateTime now);\r\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"8-\ubcf4\uc548-\uac15\ud654-\ud3ec\uc778\ud2b8",children:"8. \ubcf4\uc548 \uac15\ud654 \ud3ec\uc778\ud2b8"}),"\n",(0,i.jsx)(n.h3,{id:"1\ufe0f\u20e3-\ub2e8\uc77c-\uae30\uae30-\ub85c\uadf8\uc778",children:"1\ufe0f\u20e3 \ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"// \uc0c8 \ub85c\uadf8\uc778 \uc2dc \uae30\uc874 \ud1a0\ud070 \uc0ad\uc81c\r\nrefreshTokenRepository.deleteByUserId(user.getId());\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud6a8\uacfc"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u2705 \ud55c \uacc4\uc815\ub2f9 \ud558\ub098\uc758 Refresh Token\ub9cc \uc720\uc9c0"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \ub2e4\ub978 \uae30\uae30\uc5d0\uc11c \ub85c\uadf8\uc778 \uc2dc \uae30\uc874 \uc138\uc158 \uc790\ub3d9 \ub85c\uadf8\uc544\uc6c3"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"2\ufe0f\u20e3-\ud1a0\ud070-\uc7ac\uc0ac\uc6a9-\uac10\uc9c0",children:"2\ufe0f\u20e3 \ud1a0\ud070 \uc7ac\uc0ac\uc6a9 \uac10\uc9c0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public TokenPair refreshAccessToken(String refreshTokenStr) {\r\n    RefreshToken refreshToken = refreshTokenRepository\r\n        .findByToken(refreshTokenStr)\r\n        .orElseThrow(() -> {\r\n            // \ud1a0\ud070\uc774 DB\uc5d0 \uc5c6\uc74c \u2192 \uc774\ubbf8 \uc0ac\uc6a9\ub428 \ub610\ub294 \ud0c8\ucde8 \uc758\uc2ec\r\n            log.warn("Refresh Token \uc7ac\uc0ac\uc6a9 \uac10\uc9c0: token={}", refreshTokenStr);\r\n            throw new InvalidTokenException("Refresh Token\uc774 \uc720\ud6a8\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.");\r\n        });\r\n\r\n    // ...\r\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"3\ufe0f\u20e3-access-token-\uc9e7\uc740-\ub9cc\ub8cc-\uc2dc\uac04",children:"3\ufe0f\u20e3 Access Token \uc9e7\uc740 \ub9cc\ub8cc \uc2dc\uac04"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"Token accessToken = jwtTokenProvider.generateAccessToken(\r\n    user.getId(),\r\n    user.getEmail(),\r\n    user.getRole(),\r\n    Duration.ofHours(1)  // 1\uc2dc\uac04\r\n);\r\n\r\nToken refreshToken = jwtTokenProvider.generateRefreshToken(\r\n    user.getId(),\r\n    Duration.ofDays(14)  // 2\uc8fc\r\n);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\uc804\ub7b5"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Access Token: 1\uc2dc\uac04 (\ud0c8\ucde8 \uc2dc \ud53c\ud574 \ucd5c\uc18c\ud654)"}),"\n",(0,i.jsx)(n.li,{children:"Refresh Token: 2\uc8fc (\uc0ac\uc6a9\uc790 \ud3b8\uc758\uc131 \ud655\ubcf4)"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"9-\uacb0\ub860",children:"9. \uacb0\ub860"}),"\n",(0,i.jsx)(n.admonition,{title:"\uc131\uacfc",type:"success",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Refresh Token\uc744 ",(0,i.jsx)(n.strong,{children:"PostgreSQL\uc5d0 \uc800\uc7a5"}),"\ud558\uc5ec \ubcf4\uc548 \uac15\ud654"]}),"\n",(0,i.jsxs)(n.li,{children:["\ub85c\uadf8\uc544\uc6c3 \uc2dc DB\uc5d0\uc11c ",(0,i.jsx)(n.strong,{children:"\uc989\uc2dc \uc0ad\uc81c"})," \u2192 \uc7ac\uc0ac\uc6a9 \ubd88\uac00"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud1a0\ud070 \ud0c8\ucde8 \uac10\uc9c0 \uc2dc \ud574\ub2f9 \uc0ac\uc6a9\uc790\uc758 ",(0,i.jsx)(n.strong,{children:"\ubaa8\ub4e0 \ud1a0\ud070 \ubb34\ud6a8\ud654"})," \uac00\ub2a5"]}),"\n",(0,i.jsx)(n.li,{children:"\ub2e8\uc77c \uae30\uae30 \ub85c\uadf8\uc778 \uc9c0\uc6d0"}),"\n"]})}),"\n",(0,i.jsx)(n.admonition,{title:"\ubc30\uc6b4 \uc810",type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JWT\uc758 Stateless \ud2b9\uc131"}),"\uacfc ",(0,i.jsx)(n.strong,{children:"\ubcf4\uc548 \uc694\uad6c\uc0ac\ud56d"}),"\uc758 \ud2b8\ub808\uc774\ub4dc\uc624\ud504"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Refresh Token \uad00\ub9ac \uc804\ub7b5"}),"\uc758 \uc911\uc694\uc131"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Redis vs DB \uc120\ud0dd \uae30\uc900"})," (\uc131\ub2a5 vs \ubcf4\uc548/\ucd94\uc801)"]}),"\n"]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"10-\ucd94\uac00-\uace0\ub824\uc0ac\ud56d",children:"10. \ucd94\uac00 \uace0\ub824\uc0ac\ud56d"}),"\n",(0,i.jsx)(n.h3,{id:"\ub85c\uadf8-\ubd84\uc11d",children:"\ub85c\uadf8 \ubd84\uc11d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \ucd5c\uadfc \ub85c\uadf8\uc778 \uc774\ub825 \uc870\ud68c\r\nSELECT user_id, COUNT(*) as login_count, MAX(created_at) as last_login\r\nFROM refresh_tokens\r\nWHERE created_at > NOW() - INTERVAL '7 days'\r\nGROUP BY user_id\r\nORDER BY login_count DESC;\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"11-\ucc38\uace0-\uc790\ub8cc",children:"11. \ucc38\uace0 \uc790\ub8cc"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html",children:"OWASP - JWT Security Cheat Sheet"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc6749",children:"RFC 6749 - OAuth 2.0 Framework"})}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453(e,n,r){r.d(n,{R:()=>l,x:()=>t});var s=r(6540);const i={},o=s.createContext(i);function l(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);